<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="renderer" content="webkit">
  <title>易露云</title>
  <link rel="stylesheet" href="/eluyun/static/css/bootstrap.min.css">
  <link rel="stylesheet" href="/eluyun/static/css/main.min.css">
  <script src="/eluyun/static/js/jquery.min.js"></script>
  <script src="/eluyun/static/js/jquery.validate.min.js"></script>
  <script src="/eluyun/static/js/validation.js"></script>
  <script src="/eluyun/static/js/ajaxurl.js"></script>
  <script src="/eluyun/static/js/jquery.cookie.js"></script>
  <script src="/eluyun/static/js/jquery.ui.widget.js"></script>
  <script src="/eluyun/static/js/jquery.iframe-transport.js"></script>
  <script src="/eluyun/static/js/jquery.fileupload.js"></script>
  <script src="/eluyun/static/js/bootstrap.min.js"></script>
  <!--[if lte IE 9]>
  <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv-printshiv.js"></script>
  <![endif]-->
  <script src="/eluyun/static/js/main.js"></script>
  <script src="/eluyun/static/js/app/src/category/food/food.js"></script>
</head>
<body>
  <!-- 新增餐饮 -->
  <div class="modal fade" role="dialog" id="createFood">
    <div class="modal-dialog modal-w626">
      <div class="modal-content clearfloat">
        <div class="createFood clearfloat">
          <form class="inputFiled">
            <h1>新增餐饮</h1>
            <h2>基本信息</h2>
            <ul>
              <li>
                <label for="createFoodName">餐饮名称</label>
                <input maxlength="16" type="text" class="text required" id="createFoodName" name="" placeholder="用于展示给客户">
              </li>
              <li>
                <label for="createFoodShortName">简称</label>
                <input maxlength="6" type="text" class="text required" id="createFoodShortName" name="" placeholder="用于自己管理">
              </li>
              <li>
                <label for="createFoodUnit">单位</label>
                <input maxlength="8" type="text" class="text required" id="createFoodUnit" name="" placeholder="请填写单位">
              </li>
              <li>
                <label for="createFoodFitNum">适用人数</label>
                <input maxlength="8" range="[1,99999999]" digits="true" type="text" class="text required" id="createFoodFitNum" name="" placeholder="请填写纯数字">
              </li>
              <li>
                <label for="createFoodInventory">默认库存</label>
                <input maxlength="8" range="[1,99999999]" digits="true" type="text" class="text required" id="createFoodInventory" name="" placeholder="请填写纯数字">
              </li>
              <li>
                <label for="createFoodPrice">单价</label>
                <input maxlength="8" range="[0,99999999]" type="text" class="text required" id="createFoodPrice" name="" placeholder="请填写纯数字">
              </li>
              <li>
                <label for="createFoodDescription">描述</label>
                <textarea maxlength="140" name="description" id="createFoodDescription" name="" placeholder="请填写描述"></textarea>
              </li>
            </ul>
          </form>
          <div class="footer">
            <button class="btn-cancel">取消</button>
            <button class="btn-ok" id="createFoodOk">确认</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 编辑基本信息 -->
  <div class="modal fade" role="dialog" id="editFood">
    <div class="modal-dialog modal-w626">
      <div class="modal-content clearfloat">
        <div class="editFood clearfloat">
          <form class="inputFiled">
            <h1>编辑餐饮</h1>
            <h2>基本信息</h2>
            <ul>
              <li>
                <label for="editFoodName">餐饮名称</label>
                <input maxlength="16" id="editFoodName" type="text" class="text required" name="editFoodName" placeholder="用于展示给客户">
              </li>
              <li>
                <label for="editFoodShortName">简称</label>
                <input maxlength="6" id="editFoodShortName" type="text" class="text required" name="editFoodShortName" placeholder="用于自己管理">
              </li>
              <li>
                <label for="editFoodUnit">单位</label>
                <input maxlength="8" id="editFoodUnit" type="text" class="text required" name="editFoodUnit" placeholder="请填写单位">
              </li>
              <li>
                <label for="editFoodFitNum">适用人数</label>
                <input maxlength="8" range="[1,99999999]" digits="true" id="editFoodFitNum" type="text" class="text required" name="editFoodFitNum" placeholder="请填写纯数字">
              </li>
              <li>
                <label for="editFoodInventory">默认库存</label>
                <input maxlength="8" range="[1,99999999]" digits="true" id="editFoodInventory" type="text" class="text required" name="editFoodInventory" placeholder="请填写纯数字">
              </li>
              <li>
                <label for="editFoodPrice">单价</label>
                <input maxlength="8" range="[0,99999999]" id="editFoodPrice" type="text" class="text required" name="editFoodPrice" placeholder="请填写纯数字">
              </li>
              <li>
                <label for="editFoodDescription">描述</label>
                <textarea maxlength="140" id="editFoodDescription" name="description" name="editFoodDescription" placeholder="请填写描述"></textarea>
              </li>
            </ul>
          </form>
          <div class="footer">
            <button class="btn-cancel">取消</button>
            <button class="btn-ok" id="editFoodOk">确定</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 编辑展示信息 -->
  <div class="modal fade" role="dialog" id="editDisplayInfo">
    <div class="modal-dialog modal-w626">
      <div class="modal-content clearfloat">
        <div class="editDisplayInfo clearfloat">
          <h1>编辑展示信息-烧烤</h1>
          <p class="tip">这些信息会出现在直销网站以及直销APP上，更详细的信息会帮助你吸引来更多客人哦</p>
          <div class="clearfloat">
            <div class="photo">
              <h2>图片管理</h2>
              <div class="cover">
                <div class="title clearfloat">
                  <span>封面</span>
                  <div class="create">
                    <img src="/eluyun/static/image/icon_xinjian.png" alt="新增">
                    <span>上传图片</span>
                  </div>
                  <input id="cover" type="file" name="file" accept="image/*"/>
                </div>
                <div class="photoContainer"></div>
                <p class="coverError hide">请上传封面<p>
              </div>
              <div class="detail">
                <div class="title clearfloat">
                  <span>详细图片</span>
                  <div class="create">
                    <img src="/eluyun/static/image/icon_xinjian.png" alt="新增">
                    <span>上传图片</span>
                  </div>
                  <input id="detail" type="file" name="file" accept="image/*" />
                </div>
                <div class="photoContainer"></div>
                <p class="detailError hide">请上传详细图片<p>
              </div>
            </div>
            <div class="operate">
              <div class="first">
                <div class="operateItem hide">
                  <div id="replaceCover" class="clickDiv">
                    <img src="/eluyun/static/image/icon_bianjijibenxinxi.png" alt="">
                    <p>替换图片</p>
                  </div>
                </div>
                <div class="operateItem hide">
                  <div id="deleteCover" class="clickDiv">
                    <img src="/eluyun/static/image/icon_shanchu.png" alt="">
                    <p>删除</p>
                  </div>
                </div>
              </div>
              <div class="second">
                <div class="operateItem hide">
                  <div id="replaceDetail" class="clickDiv">
                    <img src="/eluyun/static/image/icon_bianjijibenxinxi.png" alt="">
                    <p>替换图片</p>
                  </div>
                  <input type="file" accept="image/*" name="file" id="replaceDetailImg" />
                </div>
                <div class="operateItem hide">
                  <div id="deleteDetail" class="clickDiv">
                    <img src="/eluyun/static/image/icon_shanchu.png" alt="">
                    <p>删除</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="footer">
            <button class="btn-cancel">取消</button>
            <button class="btn-ok" id="editFoodShowOk">确认</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--页面主体 -->
  <div class="mainContainer">
    <div class="content">
      <div class="title">
        <span class="campName"></span>
        <div class="create" data-toggle="modal" data-target="#createFood">
          <img src="/eluyun/static/image/icon_xinjian.png" alt="新增">
          <span>新增餐饮</span>
        </div>
      </div>
      <div class="categoryGrid">
        <table>
          <thead>
          <tr class="head">
            <th>餐饮</th>
            <th>简称</th>
            <th>单位</th>
            <th>适用人数</th>
            <th>默认库存</th>
            <th>单价</th>
            <th>描述</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="operate mainOperate">
        <div class="first clearfloat">
          <div class="operateItem hide">
            <div class="clickDiv" id="editFoodButton" data-toggle="modal" data-target="#editFood">
              <img src="/eluyun/static/image/icon_bianjijibenxinxi.png" alt="">
              <p>编辑基本信息</p>
            </div>
          </div>
          <div class="operateItem hide">
            <div class="clickDiv" id="deleteFoodButton">
              <img src="/eluyun/static/image/icon_shanchu.png" alt="">
              <p>删除</p>
            </div>
          </div>
        </div>
        <div class="second clearfloat hide">
          <div class="operateItem hide">
            <div class="clickDiv" id="editFoodShowInfoButton" data-toggle="modal" data-target="#editDisplayInfo">
              <img src="/eluyun/static/image/icon_bianjijibenxinxi.png" alt="">
              <p>编辑展示信息</p>
            </div>
          </div>
          <div class="operateItem hide shangjia">
            <div class="clickDiv modifyStateButton">
              <img src="/eluyun/static/image/icon_shangjia.png" alt="">
              <p>上架</p>
            </div>
            <p class="putaway">目前未上架</p>
          </div>
          <div class="operateItem hide xiajia">
            <div class="clickDiv modifyStateButton">
              <img src="/eluyun/static/image/icon_xiajia.png" alt="">
              <p>下架</p>
            </div>
            <p class="putaway">已上架</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    //列表对象
    var foodCategoryList = {};
    //渲染
    foodCategoryList.render = function(){
      var str = "";
      $.each(foodCategoryList.list, function(index, element){
        str += "<tr class='mainClass'>" +
                "<td class='gridMore'>" + element.name + "</td>" +
                "<td>" + element.shortName + "</td>" +
                "<td>" + element.unit + "</td>" +
                "<td>" + element.fitNum + "</td>" +
                "<td>" + element.inventory + "</td>" +
                "<td>" + element.price + "</td>" +
                "<td class='gridMore'>" + element.description + "</td>" +
                "<input type='hidden' class='state' value=" + element.state + " />" +
                "<input type='hidden' class='id' value=" + element.id + " /></tr>";
      });
      $(".categoryGrid tbody").html(str);
      $(".mainOperate .operateItem").addClass("hide");
      $(".mainOperate .second").addClass("hide");
      $(".categoryGrid .mainClass").on("click", function(){
        $(".mainClass").removeClass("mainActive");
        $(".subclass").removeClass("subActive");
        $(this).addClass("mainActive");
        $(".mainOperate .operateItem").removeClass("hide");
        $(".mainOperate .second").removeClass("hide");
        if ($(this).find(".state").val() == 0) {
          $(".xiajia").addClass("hide");
        } else {
          $(".shangjia").addClass("hide");
        }
      })
      $(".gridMore").on({"mouseenter":function(){
        showMoreInfo(event, this);
      },"mouseleave":function(){
        hideMoreInfo(event, this)
      }
      });
    };
    //判断空属性
    function emptyFilter(data){
      $.each(data, function(index, element){
        for (var name in element) {
          if (element[name] == null || element[name] == undefined) {
            element[name] = "";
          }
        }
      });
      return data;
    }
    //session失效验证
    function sessionValidate(data){
      if (data.code == 14) {
        location.href = "/eluyun/view/loginTest.html";
      }
    }

    //读取餐饮品类列表
    function loadFoodCategoryList(){
      $.ajax({
        url: getUrl(pullOtherCategoryListUrl),
        data: {type: 1},
        success: function(result){
          foodCategoryList.list = result.data.list;
          foodCategoryList.render();
        },
        dataFilter: function(result){
          result = JSON.parse(result);
          sessionValidate(result);
          result.data.list = emptyFilter(result.data.list);
          return JSON.stringify(result);
        }
      });
    }

    //添加
    function addFoodCategory(that){
      var item = {
        name: $("#createFoodName").val(),
        shortName: $("#createFoodShortName").val(),
        unit: $("#createFoodUnit").val(),
        fitNum: $("#createFoodFitNum").val(),
        inventory: $("#createFoodInventory").val(),
        price: $("#createFoodPrice").val(),
        description: $("#createFoodDescription").val(),
        type: 1
      };
      $.ajax({
        url: getUrl(addOrEditExtraCategoryUrl),
        type: "POST",
        data: item,
        dataFilter: function(result){
          result = JSON.parse(result);
          sessionValidate(result);
          return JSON.stringify(result);
        },
        success: function(result){
          if (errorHandler(result)) {
            clearModal(that);
          } else {
            return;
          }
          item.id = result.data.id;
          item.state = 0;
          foodCategoryList.list.push(item);
          foodCategoryList.render();
        }
      })
    }
    //编辑基本信息
    function editFoodCategory(that){
      var item = {
        id: $(".mainActive .id").val(),
        name: $("#editFoodName").val(),
        shortName: $("#editFoodShortName").val(),
        unit: $("#editFoodUnit").val(),
        fitNum: $("#editFoodFitNum").val(),
        inventory: $("#editFoodInventory").val(),
        price: $("#editFoodPrice").val(),
        description: $("#editFoodDescription").val(),
        type: 1
      };
      $.ajax({
        url: getUrl(addOrEditExtraCategoryUrl),
        type: "POST",
        data: item,
        dataFilter: function(result){
          result = JSON.parse(result);
          sessionValidate(result);
          return JSON.stringify(result);
        },
        success: function(result){
          if (errorHandler(result)) {
            clearModal(that);
          } else {
            return;
          }
          $.each(foodCategoryList.list, function(index, element){
            if (element.id == item.id) {
              var state = foodCategoryList.list[index].state;
              foodCategoryList.list[index] = item;
              foodCategoryList.list[index].state = state;
              return false; //等于break
            }
          });
          foodCategoryList.render();
        }
      });
    }

    //上架或者下架
    function modifyState(item){
      $.ajax({
        url: getUrl(modifyStateUrl),
        data: item,
        dataFilter: function (result) {
          result = JSON.parse(result); //先转为json
          sessionValidate(result);
          return JSON.stringify(result); //再转为字符串传回去
        },
        success: function (result) {
          if (!errorHandler(result)) {
            return;
          }
          $.each(foodCategoryList.list, function(index, element){
            if (element.id == item.id) {
              foodCategoryList.list[index].state = item.state;
              return false; //等于break
            }
          });
          foodCategoryList.render();
        }
      })
    }

    //删除
    function deleteFoodCategory(){
      var id = $(".mainActive .id").val();
      $.ajax({
        url: getUrl(deleteOtherCategoryUrl),
        data: {id: id},
        dataFilter: function(result){
          result = JSON.parse(result);
          sessionValidate(result);
          return JSON.stringify(result);
        },
        success: function(result){
          if (!errorHandler(result)) {
            return;
          }
          $.each(foodCategoryList.list, function(index, element){
            if (element.id == id) {
              foodCategoryList.list.splice(index, 1);
              return false; //等于break
            }
          });
          foodCategoryList.render();
        }
      });
    }

    //读取展示信息
    function pullFoodShowInfo(id){
      $.ajax({
        url: getUrl(pullShowInfoUrl),
        data: {id: id},
        dataFilter: function(result) {
          result = JSON.parse(result); //先转为json
          sessionValidate(result);
          return JSON.stringify(result); //再转为字符串传回去
        },
        success: function(result){
          showFoodShowInfo(result.data);
        }
      })
    }

    //显示展示信息
    function showFoodShowInfo(data){
      if (data.coverUrl != null) {
        $(".cover .photoContainer").html("<img onclick='selectPhoto(this)' class='coverImg' height='205px' src='" + data.coverUrl + "' />");
        $(".cover .create").hide();
      } else {
        $(".cover .photoContainer").html("");
        $(".cover .create").show();
      }
      if (data.detailImgUrl != null) {
        var detailStr = "";
        $.each(data.detailImgUrl, function(index, element){
          detailStr += "<img onclick='selectPhoto(this)' class='detailImg' height='102px' src='" + element + "' />"
        });
        $(".detail .photoContainer").html(detailStr);
        if ($(".detailImg").length == 6) {
          $(".detail .create").hide();
        } else {
          $(".detail .create").show();
        }
      } else {
        $(".detail .photoContainer").html("");
        $(".detail .create").show();
      }
      //上传图片
      $("#cover").fileupload({
        url: getUrl(uploadImageUrl),
        done: function (e, data) {
          var result = data.result[0].body ? data.result[0].body.innerHTML : data.result;
          result = JSON.parse(result);
          $(".cover .photoContainer").html("<img onclick='selectPhoto(this)' class='coverImg' height='205px' src='" + result.data.url + "' />");
          $(".cover .create").hide();
          $(".coverError").addClass("hide");
        }
      });
      $("#detail").fileupload({
        url: getUrl(uploadImageUrl),
        done: function (e, data) {
          var result = data.result[0].body ? data.result[0].body.innerHTML : data.result;
          result = JSON.parse(result);
          $(".detail .photoContainer").append("<img onclick='selectPhoto(this)' class='detailImg' height='102px' src='" + result.data.url + "' />");
          if ($(".detailImg").length == 6) {
            $(".detail .create").hide();
          }
          $(".detailError").addClass("hide");
        }
      })
    }

    //准备展示信息数据
    function makeFoodShowInfo(that){
      var detailImgUrl = [];
      $(".detailImg").each(function(){
        detailImgUrl.push($(this).attr("src"));
      });
      var item = {
        coverUrl: $(".coverImg").attr("src"),
        detailImgUrl: JSON.stringify(detailImgUrl),
        id: $(".categoryGrid").find(".mainActive").find(".id").val()
      };
      sendFoodShowInfo(item, that);
    }

    //选择图片
    function selectPhoto(obj){
      if ($(obj).hasClass("coverImg")) {
        $(obj).addClass("photoSelected");
        $("#editDisplayInfo .first .operateItem").removeClass("hide");
      } else {
        $(".detailImg").removeClass("photoSelected");
        $(obj).addClass("photoSelected");
        $("#editDisplayInfo .second .operateItem").removeClass("hide");
      }
    }

    //发送展示信息
    function sendFoodShowInfo(item, that){
      $.ajax({
        url: getUrl(editShowInfoUrl),
        data: item,
        dataFilter: function(result) {
          result = JSON.parse(result); //先转为json
          sessionValidate(result);
          return JSON.stringify(result); //再转为字符串传回去
        },
        success: function(result){
          if (errorHandler(result)) {
            clearModal(that);
          }
        }
      })
    }

    $(function(){
      //读取营地名称和用户名
      $(".campName").html(localStorage.getItem("campName"));
      $(".userName").find("a").html(localStorage.getItem("userName"));
      loadFoodCategoryList();
    });
    $("#modifyStateButton").on("click", function(){
      var item = {
        id: $(".mainActive .id").val(),
        state: 1 - $(".mainActive .state").val()
      };
      modifyState(item);
    });
    $("#createFoodOk").on("click", function(){
      if (!$("#createFood form").valid()) {
        return;
      }
      var that = this;
      addFoodCategory(that);
    });
    $("#editFoodOk").on("click", function(){
      if (!$("#editFood form").valid()) {
        return;
      }
      var that = this;
      editFoodCategory(that);
    });
    $("#editFoodButton").on("click", function(){
      $("#editFoodName").val($(".mainActive td:eq(0)").html());
      $("#editFoodShortName").val($(".mainActive td:eq(1)").html());
      $("#editFoodUnit").val($(".mainActive td:eq(2)").html());
      $("#editFoodFitNum").val($(".mainActive td:eq(3)").html());
      $("#editFoodInventory").val($(".mainActive td:eq(4)").html());
      $("#editFoodPrice").val($(".mainActive td:eq(5)").html());
      $("#editFoodDescription").val($(".mainActive td:eq(6)").html());
    });
    $("#deleteFoodButton").on("click", function(){
      confirmCallback = deleteFoodCategory;
      dialogConfig = {title:"提示", message:"您确定要删除吗？"};
      confirmDialog(dialogConfig,confirmCallback);
    });
    //上架或下架
    $(".modifyStateButton").on("click", function(){
      var item = {
        id: $(".mainActive .id").val(),
        state: 1 - $(".mainActive .state").val()
      };
      modifyState(item);
    });

    //编辑展示信息
    $("#editFoodShowInfoButton").on("click", function(){
      $("#editDisplayInfo h1").html("编辑展示信息-" + $(".mainActive td:eq(0)").html());
      $(".detail .photoContainer").html("");
      $(".cover .photoContainer").html("");
      var id = $(".mainActive .id").val();
      pullFoodShowInfo(id);
    });

    //删除封面
    $("#deleteCover").on("click", function(){
      $(".cover .photoSelected").remove();
      $("#editDisplayInfo .first .operateItem").addClass("hide");
      $(".cover .create").show();
    });

    //替换封面
    $("#replaceCover").on("click", function(){
      $("#cover").click();
    });

    //删除详细图片
    $("#deleteDetail").on("click", function(){
      $(".detail .photoSelected").remove();
      $("#editDisplayInfo .second .operateItem").addClass("hide");
      $(".detail .create").show();
    });

    //替换详细图片
    $("#replaceDetail").on("click", function(){
      $("#replaceDetailImg").click();
      $("#replaceDetailImg").fileupload({
        url: getUrl(uploadImageUrl),
        done: function (e, data) {
          var result = data.result[0].body ? data.result[0].body.innerHTML : data.result;
          result = JSON.parse(result);
          $(".detail .photoSelected").attr("src" ,result.data.url);
        }
      });
    });

    $(".cover .create").on("click", function(){
      $("#cover").click();
    });
    $(".detail .create").on("click", function(){
      $("#detail").click();
    });

    //编辑展示信息确认
    $("#editFoodShowOk").on("click", function(){
      if ($(".cover .photoContainer").html() == "") {
        $(".coverError").removeClass("hide");
        return
      }
      if ($(".detail .photoContainer").html() == "") {
        $(".detailError").removeClass("hide");
        return
      }
      var that = this;
      makeFoodShowInfo(that);
    });
  </script>
</body>
</html>